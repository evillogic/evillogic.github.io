<!doctype html><html lang=en><head><title>An LDAP Exfil Technique &ndash; wooper blog</title>
<meta name=description content="very serious intellectual thoughts /s"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w==" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin=anonymous><link rel=stylesheet href=https://blog.kazam.io/css/colour/wooper.css><link rel=stylesheet href=https://blog.kazam.io/css/colour/wooper-mode.css><link rel=stylesheet href=https://blog.kazam.io/css/risotto.css><link rel=stylesheet href=https://blog.kazam.io/css/custom.css></head><body><div class=page><header class=page__header><h1 class=page__logo><a href=https://blog.kazam.io class=page__logo-inner>wooper blog</a></h1><nav class="page__nav main-nav"><ul><li class=main-nav__item><a class=nav-main-item href=/about/ title>About</a></li><li class=main-nav__item><a class=nav-main-item href=/notes/ title=Notes>Notes</a></li><li class=main-nav__item><a class="nav-main-item active" href=/posts/ title=Posts>Posts</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>An LDAP Exfil Technique</h1></header><div class=content__body><p>Recently I’ve been looking a lot at data exfiltration techniques in general, especially techniques that allow you to bypass network access controls and escape from PCI environments.</p><p>I recently discovered a little trick that you can use to traverse network boundaries and obfuscate the source of your data via LDAP, which means that as long as the environment uses active directory and there’s a device (such as a primary domain controller) that has the ability to cross network boundaries, you can leverage this technique to use any Windows box as a proxy between two boxes you control.</p><p>The idea goes like this — almost all windows boxes expose their IPC$ share over SMB, which doesn’t actually allow access to files but instead call specific methods from that machine. Among other things, this allows us to query a domain for a user. Not just the domain that the machine is joined to, but any domain. Simply put, we kindly ask the target to query a fake domain (set up by the attacker) to query for a specific user containing our data to be exfiltrated.</p><p>The mechanics of this are as follows:</p><ol><li>Query a target for User: Data and Domain: ATTACKER.COM</li><li>Target issues a DNS SRV request for _ldap._tcp.SCF._sites.dc._msdcs.ATTACKER.COM</li><li>If ATTACKER.COM replied correctly, Target issues a CLDAP request to port 389 containing the data we have specified.</li></ol><p>There’s a second, bonus technique here that we can use this to obfuscate the source of our DNS exfiltration, as the requests will look like they’re coming from our target.</p><p>I’ve successfully tested this technique and works well. The only issues arise when UDP traffic is blocked, as the request will come out as a UDP CLDAP packet, or when the DNS has issues. I might post my PoC code for replying properly with a SRV record if there’s interest. </p><p>This was heavily inspired by <a href=https://web.archive.org/web/20220520135811/https://sensepost.com/blog/2018/a-new-look-at-null-sessions-and-user-enumeration/>Reino Mostert’s post a couple years back about Null Session attacks</a>. This attack is possible where Null Session attacks are possible, but also since this is an exfiltration technique we can assume we’ve compromised domain credentials and perform the technique with those instead, which would make this technique blend in a little bit more and opens up the scope.</p><p>Another quick note is that this tecnique could be used for two-way communications since it allows for a response by the domain controller.</p></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><img class=about__logo src=https://blog.kazam.io/static/sk8r-wooper.png alt=Logo><h1 class=about__title>wooper blog</h1><p class=about__description>very serious intellectual thoughts /s</p></div><ul class=aside__social-links><li><a href=https://github.com/evillogic rel=me aria-label=GitHub title=GitHub><i class="fab fa-github" aria-hidden=true></i></a>&nbsp;</li><li><a href=mailto:evillogic1@gmail.com rel=me aria-label=Email title=Email><i class="fas fa-envelope" aria-hidden=true></i></a>&nbsp;</li><li><a href=#ZgotmplZ rel=me aria-label="Happy Hacking!" title="Happy Hacking!"><i class="ai ai-arxiv" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>2020-05-06</p></div></section><footer class=page__footer><p class=copyright>© 2024 Kaz Bishop</p><p class=advertisement>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p><script defer language=javascript type=text/javascript src=/js/copy.js></script></footer></div></body></html>